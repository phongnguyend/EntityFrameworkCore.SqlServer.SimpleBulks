using System;
using System.Collections.Generic;
using System.Data;
using System.Linq;
using System.Threading;
using System.Threading.Tasks;

namespace EntityFrameworkCore.SqlServer.SimpleBulks.Extensions;

public static class IListExtensions
{
    public static DataTable ToDataTable<T>(this IReadOnlyCollection<T> data, IReadOnlyCollection<string> propertyNames, IReadOnlyDictionary<string, ValueConverter> valueConverters = null, bool addIndexNumberColumn = false, Discriminator discriminator = null, CancellationToken cancellationToken = default)
    {
        cancellationToken.ThrowIfCancellationRequested();

        var table = new DataTable() { MinimumCapacity = data.Count };

        foreach (var propName in propertyNames)
        {
            cancellationToken.ThrowIfCancellationRequested();

            table.Columns.Add(propName, PropertiesCache<T>.GetPropertyUnderlyingType(propName, valueConverters));
        }

        if (addIndexNumberColumn)
        {
            table.Columns.Add(Constants.AutoGeneratedIndexNumberColumn, typeof(long));
        }

        var hasDiscriminator = discriminator != null && !propertyNames.Contains(discriminator.PropertyName);

        if (hasDiscriminator)
        {
            table.Columns.Add(discriminator.PropertyName, discriminator.PropertyType);
        }

        long idx = 0;

        foreach (T item in data)
        {
            cancellationToken.ThrowIfCancellationRequested();

            var row = table.NewRow();

            foreach (var propName in propertyNames)
            {
                cancellationToken.ThrowIfCancellationRequested();

                row[propName] = PropertiesCache<T>.GetPropertyValue(propName, item, valueConverters) ?? DBNull.Value;
            }

            if (addIndexNumberColumn)
            {
                row[Constants.AutoGeneratedIndexNumberColumn] = idx;
            }

            if (hasDiscriminator)
            {
                row[discriminator.PropertyName] = discriminator.PropertyValue ?? DBNull.Value;
            }

            table.Rows.Add(row);

            idx++;
        }
        return table;
    }

    public static async Task<DataTable> ToDataTableAsync<T>(this IReadOnlyCollection<T> data, IReadOnlyCollection<string> propertyNames, IReadOnlyDictionary<string, ValueConverter> valueConverters = null, bool addIndexNumberColumn = false, Discriminator discriminator = null, CancellationToken cancellationToken = default)
    {
        return await Task.Run(() =>
        {
            return data.ToDataTable(propertyNames, valueConverters, addIndexNumberColumn, discriminator, cancellationToken);
        }, cancellationToken);
    }
}
